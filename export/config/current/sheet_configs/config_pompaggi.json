{
    "sheet": "Pompaggi",
    "skip": false,
    "sources": [
        {
            "fields": [
                {"name": "acq_pompaggio.codice_ato","alias": "codice_ato"},
                {"name": "acq_pompaggio.denom","alias": "denom"},
                {"name": "acq_pompaggio.quota","alias": "quota"},
                {"name": "acq_pompaggio.anno_costr","alias": "anno_costr"},
                {"name": "acq_auth_pompag.anno_ristr_civ","alias": "anno_ristr_civ"},
                {"name": "acq_auth_pompag.d_stato_cons_civ","alias": "d_stato_cons_civ"},
                {"name": "acq_auth_pompag.anno_ristr_elmec","alias": "anno_ristr_elmec"},
                {"name": "acq_auth_pompag.d_stato_cons_elmec","alias": "d_stato_cons_elmec"},
                {"name": "acq_auth_pompag.d_telecont","alias": "d_telecont"},
                {"name": "acq_auth_pompag.sn_strum_mis_pres","alias": "sn_strum_mis_pres"},
                {"name": "acq_auth_pompag.sn_strum_mis_port","alias": "sn_strum_mis_port"},
                {"name": "acq_pompaggio.d_stato","alias": "d_stato"},
                {"name": "acq_pompaggio.cod_comune", "alias":"cod_comune"},
                {"name": "acq_pompaggio.a_anno_costr","alias": "a_anno_costr"},
                {"name": "acq_auth_pompag.a_anno_ristr_civ","alias": "a_anno_ristr_civ"},
                {"name": "acq_auth_pompag.a_anno_ristr_elmec","alias": "a_anno_ristr_elmec"},
                {"name": "acq_pompaggio.data_agg","alias": "data_agg"},
                {"name": "acq_pompaggio.geom", "alias": "transformed_x_geom", "function": "GB_X"},
                {"name": "acq_pompaggio.geom", "alias": "transformed_y_geom", "function": "GB_Y"},
                {"name":"stats_pompe.sum_potenza", "alias": "sum_potenza"},
                {"name":"stats_pompe.avg_idx_potenza", "alias": "avg_idx_potenza"},
                { "name": "localita.denominazi", "alias": "denominazi" }
            ],
            "table": {
                "name": "acq_pompaggio"
            },
            "join": [
                {
                    "type": "left",
                    "table": {
                        "name": "acq_auth_pompag"
                    },
                    "on": [
                        "acq_auth_pompag.id_pompaggio",
                        "acq_pompaggio.idgis"
                    ],
                    "cond": "="
                },
                {
                   "type":"left",
                   "table":{
                      "name":"stats_pompe"
                   },
                   "on":[
                      "stats_pompe.codice_ato",
                      "acq_pompaggio.codice_ato"
                   ],
                   "cond":"="
                },
                {
                     "type": "left",
                     "table": {
                         "name": "localita"
                     },
                     "on": [
                         "localita.geom",
                         "acq_pompaggio.geom"
                     ],
                     "cond": "ST_INTERSECTS"
                }
            ],
            "filter": "WHERE acq_pompaggio.d_gestore = 'PUBLIACQUA' AND acq_pompaggio.d_ambito IN ('AT3', NULL) AND acq_pompaggio.d_stato NOT IN ('IPR', 'IAC')"
        },
        {
            "fields": [
                {"name": "a_acq_pompaggio.codice_ato","alias": "codice_ato"},
                {"name": "a_acq_pompaggio.denom","alias": "denom"},
                {"name": "a_acq_pompaggio.quota","alias": "quota"},
                {"name": "a_acq_pompaggio.anno_costr","alias": "anno_costr"},
                {"name": "acq_auth_pompag.anno_ristr_civ","alias": "anno_ristr_civ"},
                {"name": "acq_auth_pompag.d_stato_cons_civ","alias": "d_stato_cons_civ"},
                {"name": "acq_auth_pompag.anno_ristr_elmec","alias": "anno_ristr_elmec"},
                {"name": "acq_auth_pompag.d_stato_cons_elmec","alias": "d_stato_cons_elmec"},
                {"name": "acq_auth_pompag.d_telecont","alias": "d_telecont"},
                {"name": "a_acq_pompaggio.cod_comune", "alias":"cod_comune"},
                {"name": "acq_auth_pompag.sn_strum_mis_pres","alias": "sn_strum_mis_pres"},
                {"name": "acq_auth_pompag.sn_strum_mis_port","alias": "sn_strum_mis_port"},
                {"name": "a_acq_pompaggio.d_stato","alias": "d_stato"},
                {"name": "a_acq_pompaggio.a_anno_costr","alias": "a_anno_costr"},
                {"name": "acq_auth_pompag.a_anno_ristr_civ","alias": "a_anno_ristr_civ"},
                {"name": "acq_auth_pompag.a_anno_ristr_elmec","alias": "a_anno_ristr_elmec"},
                {"name": "a_acq_pompaggio.data_agg","alias": "data_agg"},
                {"name": "a_acq_pompaggio.geom", "alias": "transformed_x_geom", "function": "GB_X"},
                {"name": "a_acq_pompaggio.geom", "alias": "transformed_y_geom", "function": "GB_Y"},
                {"name": "stats_pompe.sum_potenza", "alias": "sum_potenza"},
                {"name": "stats_pompe.avg_idx_potenza", "alias": "avg_idx_potenza"},
                { "name": "localita.denominazi", "alias": "denominazi" }
            ],
            "table": {
                "name": "a_acq_pompaggio"
            },
            "join": [
                {
                    "type": "left",
                    "table": {
                        "name": "acq_auth_pompag"
                    },
                    "on": [
                        "acq_auth_pompag.id_pompaggio",
                        "a_acq_pompaggio.idgis"
                    ],
                    "cond": "="
                },
                {
                   "type":"left",
                   "table":{
                      "name":"stats_pompe"
                   },
                   "on":[
                      "stats_pompe.codice_ato",
                      "a_acq_pompaggio.codice_ato"
                   ],
                   "cond":"="
                },
                {
                     "type": "left",
                     "table": {
                         "name": "localita"
                     },
                     "on": [
                         "localita.geom",
                         "a_acq_pompaggio.geom"
                     ],
                     "cond": "ST_INTERSECTS"
                }
            ],
            "filter": "WHERE a_acq_pompaggio.d_gestore = 'PUBLIACQUA' AND a_acq_pompaggio.d_ambito IN ('AT3', NULL) AND a_acq_pompaggio.d_stato NOT IN ('IPR', 'IAC')"
        }
    ],
    "columns": [
        {"id": "48300","transformation": { "func": "CONST",  "params": { "value": "3003"}}},

        {"id": "48600","transformation": {"func": "LSTRIP", "params": {"field": "cod_comune", "char": "0"}}},

        {"id": "47900","transformation": { "func": "DIRECT", "params": { "field": "codice_ato" }}},
        {"id": "48000","transformation": { "func": "DIRECT", "params": { "field": "denom" }}},
        {"id": "48100","transformation": { "func": "DIRECT", "params": { "field": "transformed_y_geom" }}},
        {"id": "48200","transformation": { "func": "DIRECT", "params": { "field": "transformed_x_geom" }}},
        {"id": "48400","transformation": { "func": "DIRECT", "params": { "field": "quota" }},"validations": [{
                    "func": "IF",
                    "params": {
                        "field": "48400",
                        "cond": [{
                            "and": [
                              {"operator": "!=", "value": 0}
                            ]
                        }]
                    },
                    "warning": "Foglio: {SHEET} - Riga: {ROW}, Campo: {FIELD}: Field is 0"
                }
            ]},
        {"id": "48700","transformation": { "func": "DIRECT", "params": { "field": "anno_costr" }}, "validations": [{
                    "func": "IF",
                    "params": {
                        "field": "48700",
                        "cond": [{
                            "or": [
                              {"operator": ">=", "value": "{REF_YEAR}"},
                              {"operator":  "!=", "value": 9999}
                            ]
                        }]
                    },
                    "warning": "Foglio: {SHEET} - Riga: {ROW}, Campo: {FIELD}: Field greater than ref_year"
                }
            ]},
        {"id": "48800","transformation": { "func": "DIRECT", "params": { "field": "anno_ristr_civ" }}, "validations": [{
                    "func": "IF",
                    "params": {
                        "field": "48800",
                        "cond": [{
                            "or": [
                              {"operator": ">=", "value": "{REF_YEAR}"},
                              {"operator":  "!=", "value": 9800}
                            ]
                        }]
                    },
                    "warning": "Foglio: {SHEET} - Riga: {ROW}, Campo: {FIELD}: Field greater than ref_year"
                }
            ]},
        {"id": "49000","transformation": { "func": "DIRECT", "params": { "field": "anno_ristr_elmec" }}, "validations": [{
                    "func": "IF",
                    "params": {
                        "field": "49000",
                        "cond": [{
                            "or": [
                              {"operator": ">=", "value": "{REF_YEAR}"},
                              {"operator":  "!=", "value": 9800}
                            ]
                        }]
                    },
                    "warning": "Foglio: {SHEET} - Riga: {ROW}, Campo: {FIELD}: Field greater than ref_year"
                }
            ]},
        {"id": "49500","transformation": { "func": "DIRECT", "params": { "field": "sn_strum_mis_pres" }}},
        {"id": "49600","transformation": { "func": "DIRECT", "params": { "field": "sn_strum_mis_port" }}},
        {"id": "50200","transformation": { "func": "DIRECT", "params": { "field": "data_agg" }}},
        {"id": "48500","transformation": { "func": "DIRECT", "params": { "field": "denominazi" }}},
        {"id": "49300","transformation": { "func": "DIRECT", "params": { "field": "sum_potenza" }}, "validations": [{
                    "func": "IF",
                    "params": {
                        "field": "49300",
                        "cond": [{
                            "and": [
                              {"lookup": "{49700}","operator": "=", "value": 1},
                              {"operator": ">", "value": 0}
                            ]
                        }]
                    },
                    "warning": "Foglio: {SHEET} - Riga: {ROW}, Campo: {FIELD}: Field is lower than 0"
                }
            ]},

        {"id":"49200", "transformation":{"func":"DIRECT", "params":{"field":"sum_potenza"}}},
        {"id":"50100", "transformation":{"func":"DIRECT", "params":{"field":"avg_idx_potenza"}}},

        {"id": "48900","transformation": { "func": "DOMAIN", "params": { "field": "d_stato_cons_civ", "domain_name": "D_STATO_CONS" }}, "validations": [{
                    "func": "IF",
                    "params": {
                        "field": "48900",
                        "cond": [{
                            "and": [
                              {"lookup": "{49000}","operator": ">=", "value": 2014},
                              {"operator": ">=", "value": 3}
                            ]
                        }]
                    },
                    "warning": "Foglio: {SHEET} - Riga: {ROW}, Campo: {FIELD}: Field is lower than 3"
                }
            ]},
        {"id": "49100","transformation": { "func": "DOMAIN", "params": { "field": "d_stato_cons_elmec", "domain_name": "D_STATO_CONS" }}, "validations": [{
                    "func": "IF",
                    "params": {
                        "field": "49100",
                        "cond": [{
                            "and": [
                              {"lookup": "{49000}","operator": ">=", "value": 2014},
                              {"operator": ">=", "value": 3}
                            ]
                        }]
                    },
                    "warning": "Foglio: {SHEET} - Riga: {ROW}, Campo: {FIELD}: Field is lower than 3 and year must be greater than 2014"
                }
            ]},
        {"id": "49400","transformation": { "func": "DOMAIN", "params": { "field": "d_telecont", "domain_name": "D_TELECONT" }}},

        {"id": "49700","transformation": { "func": "DOMAIN", "params": { "field": "d_stato", "domain_name": "D_STATO" }}},
        {"id": "49800","transformation": { "func": "DOMAIN", "params": { "field": "a_anno_costr", "domain_name":  "D_AFFIDABILITA" }}, "validations": [{
                    "func": "IF",
                    "params": {
                        "field": "49800",
                        "cond": [{
                            "and": [
                              {"lookup": "{48700}","operator": "=", "value": 9999},
                              {"operator": "=", "value": "X"}
                            ],
                            "or": [
                              {"lookup": "{48700}","operator": ">=", "value": 2002},
                              {"lookup": "{48700}","operator": "!=", "value": 9999},
                              {"operator": "=", "value": "A"}
                            ]
                        }]
                    },
                    "warning": "Foglio: {SHEET} - Riga: {ROW}, Campo: {FIELD}: Field is not X or A"
                }
            ]},
        {"id": "49900","transformation": { "func": "DOMAIN", "params": { "field": "a_anno_ristr_civ", "domain_name":  "D_AFFIDABILITA" }}, "validations": [{
                    "func": "IF",
                    "params": {
                        "field": "49900",
                        "cond": [{
                            "and": [
                              {"lookup": "{48800}","operator": ">=", "value": 2002},
                              {"operator": "=", "value": "A"}
                            ]
                        }]
                    },
                    "warning": "Foglio: {SHEET} - Riga: {ROW}, Campo: {FIELD}: Field is not A"
                }
            ]},
        {"id": "50000","transformation": { "func": "DOMAIN", "params": { "field": "a_anno_ristr_elmec", "domain_name":  "D_AFFIDABILITA" }}, "validations": [{
                    "func": "IF",
                    "params": {
                        "field": "50000",
                        "cond": [{
                            "and": [
                              {"lookup": "{49000}","operator": ">=", "value": 2002},
                              {"operator": "=", "value": "A"}
                            ]
                        }]
                    },
                    "warning": "Foglio: {SHEET} - Riga: {ROW}, Campo: {FIELD}: Field is not A"
                }
            ]}
    ]
}