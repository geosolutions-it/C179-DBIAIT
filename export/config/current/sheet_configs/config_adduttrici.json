{
    "sheet": "Adduttrici",
    "skip": false,
    "sources": [
        {
            "fields": [
                {"name": "acq_adduttrice.codice_ato", "alias": "codice_ato"},
                {"name": "acq_adduttrice.denom","alias": "denom"},
                {"name": "acq_adduttrice.portata_media","alias": "portata_media"},
                {"name": "acq_adduttrice.d_stato","alias": "d_stato"},
                {"name": "acq_adduttrice.a_portata_media","alias": "a_portata_media"},
                {"name": "acq_adduttrice.data_agg","alias": "data_agg"},
                {"name": "acq_adduttrice.nr_rip","alias": "nr_rip"},
                {"name": "acq_auth_adduttr.sn_strum_mis_port","alias": "sn_strum_mis_port", "function": "TO_BIT"},
                {"name": "acq_auth_adduttr.d_tipo_cloraz","alias": "d_tipo_cloraz"},
                {"name": "acq_auth_adduttr.anno_instal_clor","alias": "anno_instal_clor"},
                {"name": "acq_auth_adduttr.anno_ristr_clor","alias": "anno_ristr_clor"},
                {"name": "acq_lunghezza_rete.lunghezza","alias": "lunghezza"},
                {"name": "acq_lunghezza_rete.lunghezza_tlc","alias": "lunghezza_tlc"},
                {"name": "stats_cloratore.counter","alias": "count_cloratori"}
            ],
            "table": {
                "name": "acq_adduttrice"
            },
            "join": [
                {
                    "type": "left",
                    "table": {
                        "name": "acq_auth_adduttr"
                    },
                    "on": [
                        "acq_adduttrice.idgis",
                        "acq_auth_adduttr.id_adduttrice"
                    ],
                    "cond": "="
                },
                {
                    "type": "left",
                    "table": {
                        "name": "acq_lunghezza_rete"
                    },
                    "on": [
                        "acq_adduttrice.codice_ato",
                        "acq_lunghezza_rete.codice_ato"
                    ],
                    "cond": "="
                },
                {
                    "type": "left",
                    "table": {
                        "name": "stats_cloratore"
                    },
                    "on": [
                        "acq_adduttrice.idgis",
                        "stats_cloratore.id_rete"
                    ],
                    "cond": "="
                }
            ],
            "filter": "WHERE acq_adduttrice.d_gestore = 'PUBLIACQUA' AND acq_adduttrice.d_ambito IN ('AT3', NULL) AND acq_adduttrice.d_stato NOT IN ('IPR','IAC')"
        },
        {
            "fields": [
                {"name": "a_acq_adduttrice.codice_ato", "alias": "codice_ato"},
                {"name": "a_acq_adduttrice.denom","alias": "denom"},
                {"name": "a_acq_adduttrice.portata_media","alias": "portata_media"},
                {"name": "a_acq_adduttrice.d_stato","alias": "d_stato"},
                {"name": "a_acq_adduttrice.a_portata_media","alias": "a_portata_media"},
                {"name": "a_acq_adduttrice.data_agg","alias": "data_agg"},
                {"name": "a_acq_adduttrice.nr_rip","alias": "nr_rip"},
                {"name": "acq_auth_adduttr.sn_strum_mis_port","alias": "sn_strum_mis_port", "function": "TO_BIT"},
                {"name": "acq_auth_adduttr.d_tipo_cloraz","alias": "d_tipo_cloraz"},
                {"name": "acq_auth_adduttr.anno_instal_clor","alias": "anno_instal_clor"},
                {"name": "acq_auth_adduttr.anno_ristr_clor","alias": "anno_ristr_clor"},
                {"name": "acq_lunghezza_rete.lunghezza","alias": "lunghezza"},
                {"name": "acq_lunghezza_rete.lunghezza_tlc","alias": "lunghezza_tlc"},
                { "name": "stats_cloratore.counter","alias": "count_cloratori"}
            ],
            "table": {
                "name": "a_acq_adduttrice"
            },
            "join": [
                {
                    "type": "left",
                    "table": {
                        "name": "acq_auth_adduttr"
                    },
                    "on": [
                        "a_acq_adduttrice.idgis",
                        "acq_auth_adduttr.id_adduttrice"
                    ],
                    "cond": "="
                },
                {
                    "type": "left",
                    "table": {
                        "name": "acq_lunghezza_rete"
                    },
                    "on": [
                        "a_acq_adduttrice.codice_ato",
                        "acq_lunghezza_rete.codice_ato"
                    ],
                    "cond": "="
                },
                {
                    "type": "left",
                    "table": {
                        "name": "stats_cloratore"
                    },
                    "on": [
                        "a_acq_adduttrice.idgis",
                        "stats_cloratore.id_rete"
                    ],
                    "cond": "="
                }
            ],
            "filter": "WHERE a_acq_adduttrice.d_gestore = 'PUBLIACQUA' AND a_acq_adduttrice.d_ambito IN ('AT3', NULL) AND a_acq_adduttrice.d_stato NOT IN ('IPR','IAC')"
        }
    ],
    "columns": [
        { "id": "40500", "transformation": { "func": "CONST",  "params":{"value":"B"}} },
        { "id": "98900", "transformation": { "func": "CONST",  "params":{"value":"B"}} },
        { "id": "-2", "transformation": { "func": "DIRECT", "params": { "field": "count_cloratori" } }},

        { "id": "39400", "transformation": { "func": "DIRECT",  "params": { "field": "codice_ato" } }},
        { "id": "39500", "transformation": { "func": "DIRECT",  "params": { "field": "denom" } }},
        { "id": "39600", "transformation": { "func": "DIRECT",  "params": { "field": "portata_media" } }},
        { "id": "39700", "transformation": { "func": "DIRECT",  "params": { "field": "lunghezza" } }},
        { "id": "39900", "transformation": { "func": "DIRECT",  "params": { "field": "sn_strum_mis_port" } }},
        { "id": "40100", "transformation": { "func": "DIRECT",  "params": { "field": "anno_instal_clor" } },"validations": [{
                    "func": "IF",
                    "params": {
                        "field": "40100",
                        "cond": [{
                            "and": [
                              {"lookup": "{40000}", "operator": "=", "value": 1},
                              {"operator": "=", "value": 9800}
                            ]},{
                            "and": [
                              {"lookup": "{40000}", "operator": "!=", "value": 1}
                            ]
                        }]
                    },
                    "warning": "Foglio: {SHEET}, Riga:{ROW}, Codice_ato: {CODICE_ATO}, Campo: {FIELD}: Condizione 1: se il campo ID 40000 = 1, allora deve assumere valore 9800"
                },{
                    "func": "IF",
                    "params": {
                        "field": "40100",
                        "cond": [{
                            "or": [
                              {"operator": "<=", "value": "{REF_YEAR}"},
                              {"operator": "=", "value": 9999}
                            ]
                        }]
                    },
                    "warning": "Foglio: {SHEET}, Riga:{ROW}, Codice_ato: {CODICE_ATO}, Campo: {FIELD}: Condizione 2: non puo' essere successivo all'anno di competenza netsic (eccetto per il valore 9999)"
                }
            ]},
        { "id": "40200", "transformation": { "func": "DIRECT",  "params": { "field": "anno_ristr_clor" } },"validations": [
            {
                    "func": "IF",
                    "params": {
                        "field": "40200",
                        "cond": [
                            {
                            "and": [
                              {"lookup": "{40000}", "operator": "=", "value": 1},
                              {"operator": "=", "value": 9800}
                            ]
                        },{
                           "and": [
                              {"lookup": "{40000}", "operator": "!=", "value": 1}
                           ]
                        }]
                    },
                    "warning": "Foglio: {SHEET}, Riga:{ROW}, Codice_ato: {CODICE_ATO}, Campo: {FIELD}: Condizione 1: se il campo ID 40000 = 1, allora deve assumere valore 9800"
            }, {
                    "func": "IF",
                    "params": {
                        "field": "40200",
                        "cond": [{
                                "or": [
                                  {"operator": "<=", "value": "{REF_YEAR}"},
                                  {"operator": "=", "value": 9800}
                                ]
                            }
                        ]
                    },
                    "warning": "Foglio: {SHEET}, Riga:{ROW}, Codice_ato: {CODICE_ATO}, Campo: {FIELD}: Condizione 2: non puo' essere successivo all'anno di competenza netsic (eccetto per il valore 9800) - {REF_YEAR}"
                }
            ]
        },
        { "id": "40600", "transformation": { "func": "DIRECT",  "params": { "field": "data_agg" } }},
        { "id": "98800", "transformation": { "func": "DIRECT",  "params": { "field": "lunghezza_tlc" } }},
        { "id": "99000", "transformation": { "func": "DIRECT",  "params": { "field": "nr_rip" }}},

        {"id":"40000", "transformation":{"func":"DOMAIN", "params":{"field":"d_tipo_cloraz", "domain_name": "D_T_CLORAZ"}}, "validations": [{
                    "func": "IF",
                    "params": {
                        "field": "40000",
                        "cond": [{
                            "and": [
                              {"lookup":  "{40100}", "operator": "!=", "value": 9800},
                              {"operator": "!=", "value": 1}
                            ]},{
                            "and": [
                              {"lookup":  "{40100}", "operator": "=", "value": 9800}
                            ]
                        }]
                    },
                    "warning": "Foglio: {SHEET}, Riga:{ROW}, Codice_ato: {CODICE_ATO}, Campo: {FIELD}: se il campo ID 40100 <> 9800, allora non è ammesso il valore 1"
                }
            ]},
        {"id":"40300", "transformation":{"func":"DOMAIN", "params":{"field":"d_stato", "domain_name": "D_STATO"}}},
        {"id":"40400", "transformation":{"func":"DOMAIN", "params":{"field":"a_portata_media", "domain_name": "D_AFFIDABILITA"}}},

        {
            "id": "39800",
            "transformation":{
                "func": "IF",
                "params": {
                    "field": "lunghezza_tlc",
                    "cond": {
                        "operator": "!=",
                        "value": 0,
                        "result": 2,
                        "else": 1
                    }
                }
            }
        }
    ]
}