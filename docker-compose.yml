services:
  dbiait:
    container_name: dbiait
    restart: unless-stopped
    build:
      context: ./
      dockerfile: Dockerfile
    command: ["source /opt/conda/etc/profile.d/conda.sh && conda activate dbiait && gunicorn -c /usr/src/dbiait/deploy/gunicorn.conf.py"]
    entrypoint: ["/usr/src/dbiait/deploy/entrypoint.sh"]
    ports:
      - "8001:8000"
    env_file:
      - .env
    healthcheck:
      test: "curl -m 10 --fail --silent --write-out 'HTTP CODE : %{http_code}\n' --output /dev/null http://localhost:8000/qas/auth/"
      start_period: 20s
      interval: 20s
      timeout: 5s
      retries: 2
  #dramatiq:
  #  container_name: dramatiq
  #  build:
  #    context: ./
  #    dockerfile: Dockerfile
  #  entrypoint: sleep infinity
  #  ports:
  #    - "8000:8000"
  rabbitmq:
    container_name: rabbitmq
    image: rabbitmq:3.13-management
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 30s
      retries: 3
  db:
    container_name: postgres
    image: postgis/postgis:15-3.4-alpine
    environment:
      "POSTGRES_PASSWORD": "password"
    env_file:
      - .env
    volumes:
      - dbdata:/var/lib/postgresql/data
  
volumes:
  dbiait:
    name: dbiait-project
  dbdata:
    name: dbiait-dbdata